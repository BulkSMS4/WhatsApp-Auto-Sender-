<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ðŸ“± WhatsApp Admin Dashboard</title>
<style>
  body {
    font-family: Arial, sans-serif;
    background: #f7f7f7;
    margin: 0; padding: 0;
  }
  header {
    background: #25D366;
    color: white;
    text-align: center;
    padding: 1rem;
    font-size: 1.5em;
    font-weight: bold;
  }
  section {
    padding: 1rem;
    max-width: 900px;
    margin: 20px auto;
    background: white;
    border-radius: 10px;
    box-shadow: 0 2px 6px rgba(0,0,0,0.1);
  }
  input, textarea, select, button {
    width: 100%;
    padding: 10px;
    margin: 8px 0;
    border: 1px solid #ccc;
    border-radius: 6px;
    font-size: 1em;
  }
  button {
    background: #25D366;
    color: white;
    border: none;
    font-weight: bold;
    cursor: pointer;
  }
  button:hover { background: #1ebe5c; }
  .row { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
  .product {
    border: 1px solid #ddd;
    padding: 10px;
    margin-top: 10px;
    border-radius: 6px;
  }
  .sold {
    background: #ffeaea;
    text-decoration: line-through;
    opacity: 0.7;
  }
  h3 small {
    font-size: 0.8em;
    color: gray;
  }
  footer {
    text-align: center;
    color: #555;
    margin: 20px 0;
    font-size: 0.9em;
  }
</style>
</head>
<body>

<header>ðŸ“¦ WhatsApp Business Admin Dashboard</header>

<section>
  <h2>âž• Add New Product</h2>
  <div class="row">
    <input type="text" id="productName" placeholder="Product Name">
    <input type="text" id="productPrice" placeholder="Price (e.g. 200 GHS)">
  </div>
  <textarea id="productDesc" placeholder="Product Description"></textarea>
  <select id="productCategory">
    <option value="">Select Category</option>
    <option value="Phones">Phones</option>
    <option value="Laptops">Laptops</option>
    <option value="Accessories">Accessories</option>
    <option value="Home Appliances">Home Appliances</option>
    <option value="Fashion">Fashion</option>
  </select>
  <input type="text" id="productPayment" placeholder="Custom Payment Link">
  <input type="text" id="productWebsite" placeholder="Product Website Link">
  <button onclick="addProduct()">Add Product</button>

  <h2>ðŸ›’ All Products</h2>
  <div id="productList"></div>
</section>

<section>
  <h2>ðŸ“ž Bulk Message Sender</h2>
  <textarea id="numbersInput" rows="5" placeholder="Enter WhatsApp numbers (one per line, with country code e.g. 233593231752)"></textarea>
  <textarea id="messageInput" rows="5" placeholder="Type your message here. Use {product}, {price}, {link}, {category} for auto-fill."></textarea>
  <button onclick="sendBulkMessages()">ðŸš€ Send to All</button>
</section>

<footer>ðŸ§¾ Foster â€” Admin Panel Â© 2025</footer>

<script>
  let products = [];

  async function loadProducts() {
    const res = await fetch('/api/products');
    const data = await res.json();
    products = data;
    renderProducts();
  }

  function renderProducts() {
    const list = document.getElementById('productList');
    list.innerHTML = "";
    const grouped = {};

    // group products by category
    products.forEach(p => {
      if (!grouped[p.category]) grouped[p.category] = [];
      grouped[p.category].push(p);
    });

    for (const cat in grouped) {
      list.innerHTML += `<h3>${cat}</h3>`;
      grouped[cat].forEach(p => {
        list.innerHTML += `
          <div class="product ${p.sold ? 'sold' : ''}">
            <h3>${p.name} <small>(${p.category})</small></h3>
            <p>${p.desc}</p>
            <strong>Price:</strong> ${p.price}<br>
            <strong>Website:</strong> <a href="${p.alternatePayment}" target="_blank">${p.alternatePayment}</a><br>
            <strong>Payment:</strong> <a href="${p.onlinePayment}" target="_blank">Pay Now</a><br>
            ${p.sold ? '<em>Sold</em>' : `<button onclick="markSold('${p.id}')">Mark as Sold</button>`}
          </div>
        `;
      });
    }
  }

  async function addProduct() {
    const name = document.getElementById('productName').value.trim();
    const desc = document.getElementById('productDesc').value.trim();
    const price = document.getElementById('productPrice').value.trim();
    const payment = document.getElementById('productPayment').value.trim();
    const website = document.getElementById('productWebsite').value.trim();
    const category = document.getElementById('productCategory').value.trim();

    if (!name || !price || !category) return alert("Please fill all required fields.");

    const res = await fetch('/api/add-product', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        password: "Forgetme",
        name, desc, price, onlinePayment: payment,
        alternatePayment: website, category
      })
    });
    const data = await res.json();
    if (data.success) {
      alert("âœ… Product added!");
      loadProducts();
    } else alert(data.error || "Failed to add product.");
  }

  async function markSold(id) {
    await fetch(`/api/mark-sold/${id}`, { method: 'POST' });
    alert("âœ… Product marked as sold!");
    loadProducts();
  }

  async function sendBulkMessages() {
    const numbers = document.getElementById('numbersInput').value.trim().split('\n').filter(n => n);
    const message = document.getElementById('messageInput').value.trim();
    if (numbers.length === 0 || !message) return alert("Add numbers and message first.");

    const selectedProduct = products[products.length - 1] || {};
    const msg = message
      .replace(/{product}/g, selectedProduct.name || '')
      .replace(/{price}/g, selectedProduct.price || '')
      .replace(/{link}/g, selectedProduct.onlinePayment || '')
      .replace(/{category}/g, selectedProduct.category || '');

    for (const num of numbers) {
      await fetch('/api/send-whatsapp', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ phone: num, text: msg })
      });
      await new Promise(r => setTimeout(r, 800));
    }

    alert("âœ… Messages sent successfully!");
  }

  loadProducts();
</script>

</body>
</html>
