<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>üõçÔ∏è Storefront</title>
  <style>
    body {
      font-family: "Segoe UI", sans-serif;
      background: #f4f4f4;
      margin: 0;
      padding: 0;
    }
    header {
      background: #25D366;
      color: white;
      padding: 1rem;
      text-align: center;
      font-size: 1.4em;
      font-weight: bold;
    }
    #productContainer {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
      gap: 1rem;
      padding: 1rem;
    }
    .product {
      background: white;
      border-radius: 10px;
      padding: 1rem;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
      position: relative;
    }
    .sold-banner {
      position: absolute;
      top: 10px; right: 10px;
      background: red;
      color: white;
      padding: 5px 10px;
      border-radius: 5px;
      font-weight: bold;
      font-size: 0.9em;
    }
    button {
      background: #25D366;
      color: white;
      border: none;
      padding: 10px;
      border-radius: 6px;
      font-weight: bold;
      cursor: pointer;
      width: 100%;
      margin-top: 10px;
    }
    button:hover { background: #1ebe5c; }

    /* Modal styles */
    #chooseModal, #paymentModal {
      display: none;
      position: fixed;
      left: 0; top: 0;
      width: 100%; height: 100%;
      background: rgba(0,0,0,0.6);
      justify-content: center;
      align-items: center;
      z-index: 1000;
    }
    #chooseContent, #paymentContent {
      background: #fff;
      width: 90%;
      max-width: 600px;
      border-radius: 10px;
      padding: 1.5rem;
      text-align: center;
      position: relative;
    }
    #paymentContent iframe {
      width: 100%;
      height: 500px;
      border: none;
      border-radius: 8px;
    }
    #closeChoose, #closePayment {
      position: absolute;
      right: 15px;
      top: 10px;
      background: #ff4d4d;
      color: white;
      border: none;
      border-radius: 50%;
      width: 30px;
      height: 30px;
      font-weight: bold;
      cursor: pointer;
    }
  </style>
</head>
<body>

<header>üõçÔ∏è Available Products</header>

<div id="productContainer"></div>

<!-- ü™ô Choose Payment Modal -->
<div id="chooseModal">
  <div id="chooseContent">
    <button id="closeChoose" onclick="closeChoose()">‚úñ</button>
    <h2>Select Payment Option</h2>
    <p>Choose your preferred payment method:</p>
    <button id="choosePaystack" style="background:#007bff;">üí≥ Secure Online (Card/MoMo)</button>
    <button id="chooseAlternate" style="background:#ff9800;">üîó Alternate Payment Link</button>
  </div>
</div>

<!-- üí≥ Payment Frame Modal -->
<div id="paymentModal">
  <div id="paymentContent">
    <button id="closePayment" onclick="closePayment()">‚úñ</button>
    <iframe id="paymentFrame"></iframe>
  </div>
</div>

<script>
  let products = [];
  let selectedProduct = null;

  // Fetch and render products
  async function loadProducts() {
    try {
      const res = await fetch('/api/products');
      products = await res.json();
      renderProducts();
    } catch (err) {
      console.error('Error loading products:', err);
    }
  }

  function renderProducts() {
    const container = document.getElementById('productContainer');
    container.innerHTML = '';
    products.forEach(p => {
      const div = document.createElement('div');
      div.className = 'product';
      div.innerHTML = `
        ${p.sold ? '<div class="sold-banner">SOLD OUT</div>' : ''}
        <h3>${p.name}</h3>
        <p>${p.desc || ''}</p>
        <strong>Price:</strong> ${p.price}<br>
        ${!p.sold ? `<button onclick="openPaymentChoice('${p.id}')">Buy Now</button>` : ''}
      `;
      container.appendChild(div);
    });
  }

  function openPaymentChoice(id) {
    selectedProduct = products.find(p => p.id === id);
    if (!selectedProduct) return;
    document.getElementById('chooseModal').style.display = 'flex';
  }

  document.getElementById('choosePaystack').onclick = async () => {
    if (!selectedProduct) return;
    closeChoose();
    try {
      const email = prompt("Enter your email for receipt:");
      if (!email) return alert("Email required to continue.");
      const res = await fetch('/api/paystack/initiate', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          email,
          amount: selectedProduct.price.replace(/[^\d]/g, ''), // numeric only
          productId: selectedProduct.id
        })
      });
      const data = await res.json();
      if (data.authorization_url) {
        openInDashboard(data.authorization_url);
      } else {
        alert("Payment failed to initialize.");
      }
    } catch (err) {
      console.error(err);
      alert("Error starting payment.");
    }
  };

  document.getElementById('chooseAlternate').onclick = () => {
    if (!selectedProduct) return;
    closeChoose();
    if (selectedProduct.alternatePayment)
      openInDashboard(selectedProduct.alternatePayment);
    else
      alert("No alternate payment link available.");
  };

  function openInDashboard(url) {
    const frame = document.getElementById('paymentFrame');
    frame.src = url;
    document.getElementById('paymentModal').style.display = 'flex';
  }

  function closeChoose() {
    document.getElementById('chooseModal').style.display = 'none';
  }

  function closePayment() {
    document.getElementById('paymentModal').style.display = 'none';
    document.getElementById('paymentFrame').src = '';
  }

  // Auto-refresh product list every 30s
  setInterval(loadProducts, 30000);
  loadProducts();
</script>
</body>
</html>
