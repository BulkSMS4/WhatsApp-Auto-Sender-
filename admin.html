<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>📱 WhatsApp Business Admin Dashboard</title>
<style>
  body {
    font-family: Arial, sans-serif;
    margin: 0;
    background: #f4f4f4;
    color: #222;
  }
  header {
    background: #25D366;
    color: white;
    text-align: center;
    padding: 1rem;
    font-size: 1.5em;
    font-weight: bold;
    position: sticky;
    top: 0;
    z-index: 10;
  }
  #sidebar {
    width: 220px;
    background: #202c33;
    color: white;
    position: fixed;
    top: 0;
    bottom: 0;
    left: 0;
    overflow-y: auto;
    transition: all 0.3s;
    padding-top: 80px;
  }
  #sidebar.hidden { left: -230px; }
  #sidebar ul { list-style: none; padding: 0; }
  #sidebar li { padding: 12px 20px; cursor: pointer; }
  #sidebar li:hover { background: #25D366; }
  #content {
    margin-left: 240px;
    padding: 20px;
    transition: all 0.3s;
  }
  #sidebar.hidden + #content { margin-left: 20px; }

  input, textarea, select, button {
    width: 100%;
    padding: 10px;
    margin: 8px 0;
    border-radius: 6px;
    border: 1px solid #ccc;
    font-size: 1em;
  }
  button {
    background: #25D366;
    color: white;
    border: none;
    cursor: pointer;
    font-weight: bold;
  }
  button:hover { background: #1ebe5c; }

  .section {
    background: white;
    padding: 20px;
    border-radius: 10px;
    margin-bottom: 20px;
    box-shadow: 0 2px 6px rgba(0,0,0,0.1);
  }
  .product { border-bottom: 1px solid #eee; padding: 10px 0; }
  .product.sold { opacity: 0.6; text-decoration: line-through; }
  .category-label { color: #25D366; font-weight: bold; }
</style>
</head>
<body ontouchstart="hideSidebar()" onclick="hideSidebar()">

<header onclick="toggleSidebar()">📦 WhatsApp Admin Dashboard</header>

<div id="sidebar">
  <ul>
    <li onclick="showSection('products')">🛒 Products</li>
    <li onclick="showSection('messages')">💬 Bulk Messages</li>
    <li onclick="showSection('calculator')">📦 Delivery Calculator</li>
    <li onclick="showSection('buyers')">🧾 Buyers</li>
    <li onclick="showSection('track')">📊 Track Visits</li>
  </ul>
</div>

<div id="content">
  <!-- PRODUCTS -->
  <div id="products" class="section">
    <h2>➕ Add Product</h2>
    <div class="row">
      <input type="text" id="productName" placeholder="Product Name">
      <input type="text" id="productPrice" placeholder="Price (e.g. 200 GHS)">
    </div>
    <textarea id="productDesc" placeholder="Product Description"></textarea>
    <select id="productCategory">
      <option value="">Select Category</option>
      <option value="Phones">📱 Phones</option>
      <option value="Rings">💍 Rings</option>
      <option value="Toys">🧸 Toys</option>
      <option value="Cars">🚗 Cars</option>
      <option value="Trucks">🚚 Trucks</option>
      <option value="Food">🍔 Food</option>
      <option value="Find Jobs">💼 Find Jobs</option>
    </select>
    <input type="text" id="productPayment" placeholder="Custom Payment Link">
    <input type="text" id="productWebsite" placeholder="Product Website Link">
    <button onclick="addProduct()">Add Product</button>

    <h3>🛍️ All Products</h3>
    <div id="productList"></div>
  </div>

  <!-- MESSAGES -->
  <div id="messages" class="section" style="display:none;">
    <h2>💬 Send Bulk Messages</h2>
    <textarea id="numbersInput" rows="5" placeholder="Enter numbers (one per line, with country code)"></textarea>
    <textarea id="messageInput" rows="5" placeholder="Type message (use {product}, {price}, {link})"></textarea>
    <button onclick="sendBulkMessages()">🚀 Send Messages</button>
  </div>

  <!-- CALCULATOR -->
  <div id="calculator" class="section" style="display:none;">
    <h2>🚚 Delivery Calculator</h2>
    <select id="deliveryType">
      <option value="Standard">Standard Delivery</option>
      <option value="Express">Express Delivery</option>
    </select>
    <input type="number" id="basePrice" placeholder="Enter Product Base Price">
    <button onclick="calcDelivery()">Calculate Total</button>
    <h3 id="totalDisplay"></h3>
  </div>

  <!-- BUYERS -->
  <div id="buyers" class="section" style="display:none;">
    <h2>🧾 Buyers Information</h2>
    <div id="buyersList"></div>
  </div>

  <!-- TRACK -->
  <div id="track" class="section" style="display:none;">
    <h2>📊 Product Visits</h2>
    <div id="visitList"></div>
  </div>
</div>

<script>
let products = [];

async function loadProducts() {
  const res = await fetch('/api/products');
  products = await res.json();
  renderProducts();
}

function renderProducts() {
  const list = document.getElementById('productList');
  list.innerHTML = "";
  products.forEach(p => {
    list.innerHTML += `
      <div class="product ${p.sold ? 'sold' : ''}">
        <strong>${p.name}</strong> <span class="category-label">(${p.category})</span><br>
        ${p.desc}<br>
        <strong>Price:</strong> ${p.price}<br>
        <a href="/track/${p.id}" target="_blank">Check Out</a><br>
        <button onclick="markSold('${p.id}')">Mark as Sold</button>
      </div>`;
  });
}

async function addProduct() {
  const name = productName.value.trim();
  const desc = productDesc.value.trim();
  const price = productPrice.value.trim();
  const category = productCategory.value.trim();
  const onlinePayment = productPayment.value.trim();
  const alternatePayment = productWebsite.value.trim();

  if (!name || !price) return alert("Enter name and price!");

  const res = await fetch('/api/add-product', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ password: "Forgetme", name, desc, price, category, onlinePayment, alternatePayment })
  });
  const data = await res.json();
  if (data.success) { alert("✅ Added!"); loadProducts(); }
}

async function markSold(id) {
  await fetch('/api/mark-sold', { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify({id}) });
  loadProducts();
}

async function sendBulkMessages() {
  const numbers = numbersInput.value.trim().split('\n');
  const msg = messageInput.value.trim();
  const p = products[products.length-1] || {};
  const filled = msg.replace(/{product}/g,p.name||'').replace(/{price}/g,p.price||'').replace(/{link}/g,`https://yourdomain.com/track/${p.id}`);
  for (const n of numbers) {
    await fetch('/api/send-whatsapp', { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({phone:n, text:filled})});
    await new Promise(r=>setTimeout(r,1000));
  }
  alert("✅ Sent!");
}

async function calcDelivery() {
  const res = await fetch('/api/calc-delivery', {
    method: 'POST', headers: {'Content-Type':'application/json'},
    body: JSON.stringify({ type: deliveryType.value, base: basePrice.value })
  });
  const data = await res.json();
  totalDisplay.innerText = `Total Cost: ${data.total} GHS`;
}

function showSection(id) {
  document.querySelectorAll('.section').forEach(s => s.style.display='none');
  document.getElementById(id).style.display='block';
}

function toggleSidebar() {
  document.getElementById('sidebar').classList.toggle('hidden');
}
function hideSidebar() {
  document.getElementById('sidebar').classList.add('hidden');
}

loadProducts();
</script>
</body>
</html>
